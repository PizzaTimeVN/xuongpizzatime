<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Xưởng Pizza Time</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }
        
        .login-screen, .main-screen {
            display: none;
        }
        
        .login-screen.active, .main-screen.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
        
        input[type="date"], input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #e74c3c;
        }
        
        .btn {
            background: #e74c3c;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #c0392b;
        }
        
        .btn-secondary {
            background: #34495e;
        }
        
        .btn-secondary:hover {
            background: #2c3e50;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .menu-card {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 30px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .menu-card:hover {
            border-color: #e74c3c;
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .menu-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .menu-card p {
            color: #777;
            font-size: 14px;
        }
        
        .back-btn {
            margin-bottom: 20px;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 100px;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .items-container {
            margin: 20px 0;
        }
        
        .add-item-btn {
            margin: 20px 0;
        }
        
        .store-select {
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f8f8;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .alert-item {
            padding: 8px 0;
            border-bottom: 1px solid #ffe69c;
        }
        
        .alert-item:last-child {
            border-bottom: none;
        }
        
        .current-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .current-info span {
            font-weight: 600;
            color: #e74c3c;
        }
        
        .success-msg {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        input[type="password"] {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    background-color: #e0e0e0; /* nền xám nhạt */
    transition: border-color 0.3s, background-color 0.3s;
}

        input[type="password"]:focus {
            outline: none;
            border-color: #27ae60; /* xanh lá khi focus */
            background-color: #d4f5d4; /* nhạt hơn khi focus */
        }

        /* Nút Bắt đầu - xanh lá */
        .btn-start {
            background: #27ae60;
            color: white;
        }

        .btn-start:hover {
            background: #2ecc71;
        }

        /* Nút đăng xuất - đỏ */
        .btn-logout {
            background: #e74c3c;
            color: white;
        }

        .btn-logout:hover {
            background: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Quản Lý Xưởng Pizza Time</h1>
        
        <!-- Login Screen -->
        <div class="login-screen active" id="loginScreen">
            <div class="form-group">
                <label>Ngày</label>
                <input type="date" id="loginDate" />
            </div>
            <div class="form-group">
                <label>Tên người nhập</label>
                <input type="text" id="loginName" placeholder="Nhập tên của bạn" />
                    </div>
                    <div class="form-group">
                <label>Mật khẩu</label>
                <input type="password" id="loginPassword" placeholder="Nhập mật khẩu" />
            </div>
            <button class="btn btn-start" onclick="login()">Bắt Đầu</button>
        </div>
        
        <!-- Main Screen -->
        <div class="main-screen" id="mainScreen">
            <div class="current-info">
                Ngày: <span id="currentDate"></span> | Người nhập: <span id="currentUser"></span>
                <button class="btn btn-logout" onclick="logout()">Đăng xuất</button>
            </div>

            <div class="menu-grid" id="menuGrid">
                <div class="menu-card" onclick="showScreen('rawInput')">
                    <h3>Nhập Hàng Thô</h3>
                    <p>Ghi nhận nguyên liệu nhập kho</p>
                </div>
                <div class="menu-card" onclick="showScreen('productionInput')">
                    <h3>Làm Thành Phẩm</h3>
                    <p>Ghi nhận sản xuất thành phẩm</p>
                </div>
                <div class="menu-card" onclick="showScreen('exportProduct')">
                    <h3>Xuất Thành Phẩm</h3>
                    <p>Xuất hàng cho các quán</p>
                </div>
                <div class="menu-card" onclick="showScreen('inventory')">
                    <h3>Tồn Kho</h3>
                    <p>Xem và điều chỉnh tồn kho</p>
                </div>
                <div class="menu-card" onclick="showScreen('alerts')">
                    <h3>Cảnh Báo Hàng</h3>
                    <p>Mặt hàng sắp hết</p>
                </div>
            </div>
        </div>

        
        <!-- Raw Input Screen -->
        <div id="rawInputScreen" style="display:none;">
            <button class="btn btn-secondary back-btn" onclick="backToMenu()">← Quay Lại</button>
            <h2>Nhập Hàng Thô</h2>
            <div id="rawSuccessMsg"></div>
            <div class="items-container" id="rawItemsContainer"></div>
            <button class="btn add-item-btn" onclick="addRawItem()">+ Thêm Mặt Hàng</button>
            <button class="btn" onclick="saveRawInput()">Lưu</button>
        </div>
        
        <!-- Production Input Screen -->
        <div id="productionInputScreen" style="display:none;">
            <button class="btn btn-secondary back-btn" onclick="backToMenu()">← Quay Lại</button>
            <h2>Làm Thành Phẩm</h2>
            <div id="prodSuccessMsg"></div>
            <div class="items-container" id="prodItemsContainer"></div>
            <button class="btn add-item-btn" onclick="addProdItem()">+ Thêm Mặt Hàng</button>
            <button class="btn" onclick="saveProduction()">Lưu</button>
        </div>
        
        <!-- Export Product Screen -->
        <div id="exportProductScreen" style="display:none;">
            <button class="btn btn-secondary back-btn" onclick="backToMenu()">← Quay Lại</button>
            <h2>Xuất Thành Phẩm</h2>
            <div id="exportSuccessMsg"></div>
            <div class="store-select">
                <label>Chọn Quán</label>
                <select id="storeSelect">
                    <option value="DH">DH</option>
                    <option value="NH">NH</option>
                    <option value="HXH">HXH</option>
                    <option value="PY">PY</option>
                </select>
            </div>
            <div class="items-container" id="exportItemsContainer"></div>
            <button class="btn add-item-btn" onclick="addExportItem()">+ Thêm Mặt Hàng</button>
            <button class="btn" onclick="saveExport()">Lưu</button>
        </div>
        
        <!-- Inventory Screen -->
        <div id="inventoryScreen" style="display:none;">
            <button class="btn btn-secondary back-btn" onclick="backToMenu()">← Quay Lại</button>
            <h2>Tồn Kho</h2>
            <div class="search-box">
                <input type="text" id="inventorySearch" placeholder="🔍 Tìm kiếm mặt hàng..." onkeyup="searchInventory()" />
            </div>
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th>Danh Mục</th>
                        <th>Mặt Hàng</th>
                        <th>Số Lượng</th>
                        <th>Thao Tác</th>
                    </tr>
                </thead>
                <tbody id="inventoryBody"></tbody>
            </table>
        </div>
        
        <!-- Alerts Screen -->
        <div id="alertsScreen" style="display:none;">
            <button class="btn btn-secondary back-btn" onclick="backToMenu()">← Quay Lại</button>
            <h2>Cảnh Báo Hàng Sắp Hết</h2>
            <div id="alertsContainer"></div>
        </div>
    </div>

   

    <script>
        // Supabase configuration - REPLACE WITH YOUR CREDENTIALS
        const SUPABASE_URL = 'https://tyuufjwutazjfuiawiul.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5dXVmand1dGF6amZ1aWF3aXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDk4OTIsImV4cCI6MjA3NjA4NTg5Mn0.8WEsb2tBD6akNA9h9tR9zIAqjkZz0xZYVNbYCx2dEbc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Categories and items
        const categories = {
             "🍕 Thành phẩm": [
    'Đế L',
    'Đế S',
    'Phô Mai L',
    'Phô Mai S',
    'Bò pizza (bịch)',
    'Bò mì Ý (bịch)',
    'Gà pizza (bịch)',
    'Tôm (bịch)',
    'Mực (bịch)',
    'Cá Ngừ (bịch)',
    'XXH (bịch)',
    'XXĐ (bịch)',
    'Ba Rọi (bịch)',
    'Bò sốt cay (bịch)',
    'Sốt sữa (bịch)',
    'Sốt cà (hũ)',
    'Sốt Gà',
    'Salami (bịch)',
    'Đùi Gà (cái)',
    'Đá Me (bịch)',
    'Gà Lắc (bịch)',
    'XX Chiên Xù',
    'Mứt đào (bịch)',
    'KTC (bịch)',
    'Tok (bịch)',
    'Miếng đào (bịch)',
    'Nấm (bịch)',
    'Bông Cải Xanh (bịch)',
    'Bom Phô Mai (viên)'
  ],

  "🥩 Nguyên liệu sống": [
    'Phô mai cam',
    'Phô mai Topping',
    'Phô Mai Emborg',
    'Phô mai trắng',
    'Phô mai vàng',
    'Phô mai tươi',
    'Bò nguyên',
    'Gà ức',
    'Đùi Gà',
    'Bò Miếng Sống',
    'Tôm sống (phần)',
    'Mực sống (phần)',
    'Thanh Cua Nguyên',
    'Ba Rọi Nguyên',
    'Mì Ý Nguyên',
    'Bắp (Kg)',
    'Cà chua',
    'Cà rốt',
    'Hành Tây',
    'Khoai Tây (Củ)',
    'Khoai Tây Chiên Nguyên'
  ],

  "🧂 Gia vị & nguyên liệu khô": [
    'Men (bì)',
    'Bột (bao)',
    'Đường (bì)',
    'Muối (bì)',
    'Xì dầu (chai)',
    'Rượu (chai)',
    'Tiêu',
    'Dầu ăn (can)',
    'Dầu Hào (chai)'
  ],

  "📦 Bao bì & vật dụng": [
    'Bao 1 món (kg)',
    'Bao cân bò (kg)',
    'Bao cân mì (kg)',
    'Bì vàng (kg)',
    'Bao Pizza Lớn (kg)',
    'Bao rác (kg)',
    'Dây thun (bịch)',
    'Ly nhựa (lốc)',
    'Bao Đế L (kg)',
    'Bao Đế S (kg)'
  ],

  "🥤 Đồ uống & bánh": [
    'Coca chai',
    'Coca lon',
    'Nước suối',
    'Bia Blance',
    'Bia Quy Nhơn',
    'Bánh mì'
  ]
        };
        
        
        // Set default date to today
        document.getElementById('loginDate').valueAsDate = new Date();
        
        const users = {
    "Bo": "123456",
    "Nhu2k6": "Xinh@Dep",
    "Ngan2k2": "Dep$Gioi",
    "admin": "123"
};

let currentDate = '';
let currentUser = '';

function login() {
        const date = document.getElementById('loginDate').value;
        const name = document.getElementById('loginName').value.trim();
        const password = document.getElementById('loginPassword').value;

        if (!date || !name || !password) {
            alert('Vui lòng nhập đầy đủ thông tin!');
            return;
        }

        if (!(name in users) || users[name] !== password) {
            alert('Tên người dùng hoặc mật khẩu không đúng!');
            return;
        }

        currentDate = date;
        currentUser = name;

        localStorage.setItem('currentDate', currentDate);
        localStorage.setItem('currentUser', currentUser);

        document.getElementById('loginScreen').classList.remove('active');
        document.getElementById('mainScreen').classList.add('active');

        document.getElementById('currentDate').textContent = currentDate;
        document.getElementById('currentUser').textContent = currentUser;

        loadInventory();
    }

    function logout() {
        currentDate = '';
        currentUser = '';
        localStorage.removeItem('currentDate');
        localStorage.removeItem('currentUser');

        document.getElementById('mainScreen').classList.remove('active');
        document.getElementById('loginScreen').classList.add('active');

        document.getElementById('loginDate').value = '';
        document.getElementById('loginName').value = '';
        document.getElementById('loginPassword').value = '';
    }

    // --- Load Inventory ---
    async function loadInventory() {
        const { data, error } = await supabase
            .from('inventory')
            .select('*');

        if (error) {
            console.error('Lỗi load inventory:', error);
            return;
        }

        inventoryData = {};
        data.forEach(row => {
            inventoryData[row.item] = row.quantity;
        });

        displayInventory();
        displayAlerts();
    }

    // --- Update Inventory và log ---
        async function updateInventory(itemName, quantityChange, type = 'manual', store = null) {
            const currentQty = inventoryData[itemName] || 0;
            const newQty = currentQty + quantityChange;
            inventoryData[itemName] = newQty;

            // Cập nhật Supabase inventory
            const { error: invError } = await supabase
                .from('inventory')
                .upsert({ item: itemName, quantity: newQty }, { onConflict: 'item' });

            if (invError) console.error('❌ Lỗi ghi inventory:', invError);

            // Ghi log theo loại giao dịch
            const today = new Date().toISOString().slice(0, 10);

            if (type === 'raw_input') {
                const { error } = await supabase.from('raw_materials_input').insert([{
                    date: today,
                    user_name: currentUser,
                    item: itemName,
                    quantity: quantityChange
                }]);
                if (error) console.error('❌ Lỗi ghi raw_materials_input:', error);

            } else if (type === 'production') {
                const { error } = await supabase.from('production').insert([{
                    date: today,
                    user_name: currentUser,
                    item: itemName,
                    quantity: quantityChange
                }]);
                if (error) console.error('❌ Lỗi ghi production:', error);

            } else if (type === 'export') {
                const { error } = await supabase.from('exports').insert([{
                    date: today,
                    user_name: currentUser,
                    store: store,
                    item: itemName,
                    quantity: quantityChange
                }]);
                if (error) console.error('❌ Lỗi ghi exports:', error);
            }


        displayInventory();
        displayAlerts();
    }

    // --- Item Row UI ---
    function createItemRow(containerId, categoryList) {
        const container = document.getElementById(containerId);
        const row = document.createElement('div');
        row.className = 'item-row';

        let optionsHTML = '<option value="">-- Chọn mặt hàng --</option>';
        for (let cat in categoryList) {
            optionsHTML += `<optgroup label="${cat}">`;
            categoryList[cat].forEach(item => {
                optionsHTML += `<option value="${item}">${item}</option>`;
            });
            optionsHTML += '</optgroup>';
        }

        row.innerHTML = `
            <select class="item-select">${optionsHTML}</select>
            <input type="number" class="item-quantity" placeholder="Số lượng" min="0" step="0.1" />
            <button class="btn btn-danger btn-small" onclick="this.parentElement.remove()">Xóa</button>
        `;

        container.appendChild(row);
    }

    function getItemsFromContainer(containerId) {
        const container = document.getElementById(containerId);
        const rows = container.querySelectorAll('.item-row');
        const items = [];

        rows.forEach(row => {
            const name = row.querySelector('.item-select').value;
            const quantity = parseFloat(row.querySelector('.item-quantity').value);
            if (name && quantity > 0) items.push({ name, quantity });
        });

        return items;
    }

    // --- Init các màn hình ---
    function initRawInput() {
        document.getElementById('rawItemsContainer').innerHTML = '';
        document.getElementById('rawSuccessMsg').innerHTML = '';
        addRawItem();
    }

    function addRawItem() {
        const rawCategories = {
            '🥩 Nguyên liệu sống': categories['🥩 Nguyên liệu sống'],
            '🧂 Gia vị & nguyên liệu khô': categories['🧂 Gia vị & nguyên liệu khô'],
            '📦 Bao bì & vật dụng': categories['📦 Bao bì & vật dụng'],
            '🥤 Đồ uống & bánh': categories['🥤 Đồ uống & bánh']
        };
        createItemRow('rawItemsContainer', rawCategories);
    }

    function initProdInput() {
        document.getElementById('prodItemsContainer').innerHTML = '';
        document.getElementById('prodSuccessMsg').innerHTML = '';
        addProdItem();
    }

    function addProdItem() {
        createItemRow('prodItemsContainer', {'🍕 Thành phẩm': categories['🍕 Thành phẩm']});
    }

    function initExportInput() {
        document.getElementById('exportItemsContainer').innerHTML = '';
        document.getElementById('exportSuccessMsg').innerHTML = '';
        addExportItem();
    }

    function addExportItem() {
        createItemRow('exportItemsContainer', {
            '🍕 Thành phẩm': categories['🍕 Thành phẩm'],
            '🧂 Gia vị & nguyên liệu khô': categories['🧂 Gia vị & nguyên liệu khô'],
            '📦 Bao bì & vật dụng': categories['📦 Bao bì & vật dụng'],
            '🥤 Đồ uống & bánh': categories['🥤 Đồ uống & bánh']
        });
    }

    // --- Save functions ---
    async function saveRawInput() {
        const items = getItemsFromContainer('rawItemsContainer');
        if (!items.length) return;
        for (let item of items) await updateInventory(item.name, item.quantity, 'raw_input');
        document.getElementById('rawSuccessMsg').innerHTML = '<div class="success-msg">✓ Đã lưu thành công!</div>';
        setTimeout(() => initRawInput(), 2000);
    }

    async function saveProduction() {
        const items = getItemsFromContainer('prodItemsContainer');
        if (!items.length) return;
        for (let item of items) await updateInventory(item.name, item.quantity, 'production');
        document.getElementById('prodSuccessMsg').innerHTML = '<div class="success-msg">✓ Đã lưu thành công!</div>';
        setTimeout(() => initProdInput(), 2000);
    }

    async function saveExport() {
        const store = document.getElementById('storeSelect').value;
        const items = getItemsFromContainer('exportItemsContainer');
        if (!items.length) return;
        for (let item of items) await updateInventory(item.name, -item.quantity, 'export', store);
        document.getElementById('exportSuccessMsg').innerHTML = '<div class="success-msg">✓ Đã xuất hàng thành công!</div>';
        setTimeout(() => initExportInput(), 2000);
    }

    // --- Display Inventory & Alerts ---
    function displayInventory() {
        const tbody = document.getElementById('inventoryBody');
        if (!tbody) return;
        tbody.innerHTML = '';

        for (let cat in categories) {
            categories[cat].forEach(item => {
                const qty = inventoryData[item] || 0;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cat}</td>
                    <td>${item}</td>
                    <td><input type="number" value="${qty}" step="0.1"
                        onchange="updateInventoryDirect('${item}', this.value)"
                        style="width:100px" /></td>
                    <td>${qty < 3 ? '⚠️ Sắp hết' : '✓ Đủ'}</td>
                `;
            });
        }
    }

    function updateInventoryDirect(itemName, newValue) {
        const diff = (parseFloat(newValue) || 0) - (inventoryData[itemName] || 0);
        updateInventory(itemName, diff, 'manual');
    }

    function displayAlerts() {
        const container = document.getElementById('alertsContainer');
        container.innerHTML = '';
        let lowStockItems = [];

        for (const [groupName, items] of Object.entries(categories)) {
            items.forEach(item => {
                const qty = parseFloat(inventoryData[item] || 0);
                if (qty < 3) lowStockItems.push({ name: item, quantity: qty, group: groupName });
            });
        }

        if (!lowStockItems.length) {
            container.innerHTML = '<div class="alert">✓ Không có mặt hàng nào sắp hết!</div>';
        } else {
            let html = '<div class="alert">';
            lowStockItems.forEach(item => {
                html += `<div class="alert-item">⚠️ [${item.group}] <strong>${item.name}</strong>: ${item.quantity}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }
    }

    // --- Navigation ---
    function showScreen(screen) {
        document.getElementById('mainScreen').style.display = 'none';
        ['rawInputScreen','productionInputScreen','exportProductScreen','inventoryScreen','alertsScreen']
            .forEach(s => document.getElementById(s).style.display='none');

        switch(screen) {
            case 'rawInput': document.getElementById('rawInputScreen').style.display='block'; initRawInput(); break;
            case 'productionInput': document.getElementById('productionInputScreen').style.display='block'; initProdInput(); break;
            case 'exportProduct': document.getElementById('exportProductScreen').style.display='block'; initExportInput(); break;
            case 'inventory': document.getElementById('inventoryScreen').style.display='block'; displayInventory(); break;
            case 'alerts': document.getElementById('alertsScreen').style.display='block'; displayAlerts(); break;
        }
    }

    function backToMenu() {
        ['rawInputScreen','productionInputScreen','exportProductScreen','inventoryScreen','alertsScreen']
            .forEach(s => document.getElementById(s).style.display='none');
        document.getElementById('mainScreen').style.display='block';
    }      
    </script>
</body>
</html>
